## ëŸ¬ìŠ¤íŠ¸ í”„ë¡œì íŠ¸ ìƒì„±í•˜ê¸°

### íŒŒì´ì¬ ë°”ì¸ë”©ì´ë€?

íŒŒì´ì¬ ë°”ì¸ë”©ì€ ë‹¤ë¥¸ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡œ ì‘ì„±ëœ ì½”ë“œë¥¼ íŒŒì´ì¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤. 

íŒŒì´ì¬ìš© ëŸ¬ìŠ¤íŠ¸ ë°”ì¸ë”©ì„ ì‚¬ìš©í•˜ë©´ íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ë¡œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ê³  ë°ì´í„°ë¥¼ ì „ë‹¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ë‘ ì–¸ì–´ì˜ ê°•ì ì„ ëª¨ë‘ í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ ê¸°ëŠ¥ì€ í…ŒìŠ¤íŠ¸ë¥¼ ê±°ì³ ì•ˆì •ì ìœ¼ë¡œ ì‘ì„±ëœ ëŒ€ê·œëª¨ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ íŒŒì´ì¬ì—ì„œ í™œìš©í•˜ê±°ë‚˜ íŒŒì´ì¬ ì½”ë“œì˜ íŠ¹ì • ì„¹ì…˜ì„ ëŸ¬ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ì—¬ ì†ë„ë¥¼ ë†’ì´ê³ ì í•˜ëŠ” ê²½ìš°ì— ìœ ìš©í•©ë‹ˆë‹¤.

íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ë°”ì¸ë”©ì„ ìƒì„±í•˜ëŠ” ë° ê°€ì¥ ë„ë¦¬ ì•Œë ¤ì§„ í”„ë¡œì íŠ¸ëŠ” PyO3ì…ë‹ˆë‹¤. ì´ í”„ë¡œì íŠ¸ëŠ” ëŸ¬ìŠ¤íŠ¸ë¡œ íŒŒì´ì¬ ëª¨ë“ˆì„ ì‘ì„±í•˜ê±°ë‚˜ íŒŒì´ì¬ ëŸ°íƒ€ì„ì„ ëŸ¬ìŠ¤íŠ¸ ë°”ì´ë„ˆë¦¬ì— ì„ë² ë“œí•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. PyO3ëŠ” íŒŒì´ì¬ íŒ¨í‚¤ì§• ë° ë°”ì¸ë”©ì´ í¬í•¨ëœ ëŸ¬ìŠ¤íŠ¸ ìƒìë¥¼ ì‘ì„±í•˜ëŠ” ë„êµ¬ì¸ Maturinì´ë¼ëŠ” ë˜ ë‹¤ë¥¸ í”„ë¡œì íŠ¸ë¥¼ í™œìš©í•©ë‹ˆë‹¤.



### PyO3

PyO3ëŠ” íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê³ , ë°˜ëŒ€ë¡œ ëŸ¬ìŠ¤íŠ¸ì—ì„œ íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” í¬ë ˆì´íŠ¸ì…ë‹ˆë‹¤. ìš°ë¦¬ëŠ” íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ë°°ì›Œ ë³´ê² ìŠµë‹ˆë‹¤. íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ í˜¸ì¶œí•´ ë†’ì€ ì„±ëŠ¥ í–¥ìƒì„ ë‹¬ì„±í•œ ë‹¤ì–‘í•œ ì˜ˆì‹œê°€ ìˆìŠµë‹ˆë‹¤. ì•„ë˜ì—ì„œ ê·¸ ì¤‘ ìœ ëª…í•œ ëª‡ ê°€ì§€ íŒ¨í‚¤ì§€ë¥¼ ì†Œê°œí•©ë‹ˆë‹¤.

- [orjson](https://github.com/ijl/orjson) *Fast Python JSON library* 10ë°°
- [fastuuid](https://github.com/thedrow/fastuuid/) *Python bindings to Rust's UUID library*
- [cryptography](https://github.com/pyca/cryptography) *Python cryptography library with some functionality in Rust*



### maturin

maturinì€ ìµœì†Œí•œì˜ êµ¬ì„±ìœ¼ë¡œ ëŸ¬ìŠ¤íŠ¸ë¡œ ì‘ì„±í•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

```bash
$ pipenv install maturin --dev
$ pipenv shell
```

maturinìœ¼ë¡œ pyo3 í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. -b ì˜µì…˜ì„ ì£¼ë©´ pyo3ë¥¼ ë¹Œë“œ ì‹œìŠ¤í…œìœ¼ë¡œ í•´ì„œ í”„ë¡œì íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.

```bash
$ maturin init -b pyo3
  âœ¨ Done! New project created string_sum

```

í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í´ë” êµ¬ì¡°ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

```
.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Pipfile
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ src
    â””â”€â”€ lib.rs
```

`Cargo.toml`íŒŒì¼ì—ì„œ íŒ¨í‚¤ì§€ì™€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì´ë¦„ì„ "fibonacci"ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

```toml
[package]
name = "fibonacci"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
[lib]
name = "fibonacci"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.16.5", features = ["extension-module"] }
```

`pyproject.toml` íŒŒì¼ì—ì„œë„ í”„ë¡œì íŠ¸ ì´ë¦„ì„ "fibonacci"ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.

```toml
[build-system]
requires = ["maturin>=0.13,<0.14"]
build-backend = "maturin"

[project]
name = "fibonacci"
requires-python = ">=3.7"
classifiers = [
    "Programming Language :: Rust",
    "Programming Language :: Python :: Implementation :: CPython",
    "Programming Language :: Python :: Implementation :: PyPy",
]

```



### ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬ë ˆì´íŠ¸ ë§Œë“¤ê¸°

`#[pyfunction]`ì€ PyO3 ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” ì–´íŠ¸ë¦¬ë·°íŠ¸ë¡œ, ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ íŒŒì´ì¬ í•¨ìˆ˜ë¡œ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ì— `#[pyfunction]` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ PyO3ëŠ” í•´ë‹¹ í•¨ìˆ˜ê°€ ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ì¸ ê²ƒì²˜ëŸ¼ íŒŒì´ì¬ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

`#[pymodule]`ì€ PyO3 ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ì œê³µí•˜ëŠ” ì–´íŠ¸ë¦¬ë·°íŠ¸ë¡œ, ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ë¥¼ íŒŒì´ì¬ ëª¨ë“ˆë¡œ ì •ì˜í•˜ëŠ” ë° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ì— `#[pymodule]` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ PyO3ëŠ” í•´ë‹¹ í•¨ìˆ˜ë¥¼ íŒŒì´ì¬ ëª¨ë“ˆì˜ ì´ˆê¸°í™” í•¨ìˆ˜ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

ëª¨ë“ˆì— í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ `add_function` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤. ì´ë ‡ê²Œ í•˜ë©´ ëª¨ë“ˆ ë‚´ì—ì„œ í•¨ìˆ˜ë¥¼ í˜¸ì¶œ ê°€ëŠ¥í•œ ê°ì²´ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```rust,ignore
use pyo3::prelude::*;

fn _run(n: u64) -> u64 {
    match n {
        0 => 0,
        1 => 1,
        _ => _run(n - 1) + _run(n - 2),
    }
}

#[pyfunction]
fn run(n: u64) -> PyResult<u64> {
    Ok(_run(n))
}

/// A Python module implemented in Rust.
#[pymodule]
fn fibonacci(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(run, m)?)?;
    Ok(())
}

```





## íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰í•´ ë³´ê¸°

### ê°œë°œ ëª¨ë“œë¡œ ë¹Œë“œí•´ë³´ê¸°

`maturin develop` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´, ëŸ¬ìŠ¤íŠ¸ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•œ ë‹¤ìŒ íŒŒì´ì¬ ê°€ìƒí™˜ê²½ì— íŒ¨í‚¤ì§€ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤. ì´ë•Œ ëŸ¬ìŠ¤íŠ¸ ì»´íŒŒì¼ íƒ€ê²Ÿì´ `[unoptimized + debuginfo]`ê°€ ë˜ëŠ”ë°, ë¹ ë¥¸ ê°œë°œì„ ìœ„í•´ ì½”ë“œ ì„±ëŠ¥ë³´ë‹¤ëŠ” ì»´íŒŒì¼ ì†ë„ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œ ì˜µì…˜ì…ë‹ˆë‹¤.

```bash
$ maturin develop      
ğŸ”— Found pyo3 bindings
ğŸ Found CPython 3.8 at /Users/.local/share/virtualenvs/ch14-4UzrGkRt/bin/python
   Compiling pyo3-build-config v0.16.5
   Compiling pyo3-ffi v0.16.5
   Compiling pyo3 v0.16.5
   Compiling fibonacci v0.1.0 (/Users/code/Tutorials/sap_rust_tutorial/ch14)
    Finished dev [unoptimized + debuginfo] target(s) in 12.64s
ğŸ“¦ Built wheel for CPython 3.8 to /var/folders/74/l6jhlmk114g8kx1pzz2s9fm80000gn/T/.tmpBh1Xiw/fibonacci-0.1.0-cp38-cp38-macosx_10_7_x86_64.whl
ğŸ›   Installed fibonacci-0.1.0
```

> ë§Œì¼ ê°€ìƒí™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì§€ ì•Šì„ ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•˜ë¯€ë¡œ ì£¼ì˜í•˜ì„¸ìš”!
>
> ```bash
> $ maturin develop
> ğŸ’¥ maturin failed
>   Caused by: You need to be inside a virtualenv or conda environment to use develop (neither VIRTUAL_ENV nor CONDA_PREFIX are set). See https://virtualenv.pypa.io/en/latest/index.html on how to use virtualenv or use `maturin build` and `pip install <path/to/wheel>` instead.
> ```

`main.py` íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. íŒŒì´ì¬ìœ¼ë¡œ í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´ì„ êµ¬í•˜ëŠ” í•¨ìˆ˜ `pyrun` ì„ ì¶”ê°€í•´ ëŸ¬ìŠ¤íŠ¸ êµ¬í˜„ì²´ì™€ ì„±ëŠ¥ì„ ë¹„êµí•´ë´…ë‹ˆë‹¤.

```python
import time

from fibonacci import run


def pyrun(n: int):
    if n < 2:
        return n

    return pyrun(n - 1) + pyrun(n - 2)


N = 35

start = time.time()
result = pyrun(N)
print(f"python: {time.time()-start:.2f}, result: {result}")
start = time.time()
result = run(N)
print(f"rust: {time.time()-start:.2f}, result: {result}")

```

ì‹¤í–‰ ê²°ê³¼

```bash
$ python main.py
python: 3.13, result: 9227465
rust: 0.10, result: 9227465
```



### ë¦´ë¦¬ì¦ˆ ëª¨ë“œë¡œ ë¹Œë“œí•´ë³´ê¸°

ë¹Œë“œ ì˜µì…˜ì„ `--release` ë¡œ ì£¼ë©´, ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ìµœëŒ€í•œ ìµœì í™”í•´ì„œ ì»´íŒŒì¼í•œ ë°”ì´ë„ˆë¦¬ê°€ íŒ¨í‚¤ì§€ë¡œ ë§Œë“¤ì–´ì§€ê²Œ ë©ë‹ˆë‹¤. ì»´íŒŒì¼ íƒ€ê²Ÿì´ `[optimized]`ì¸ ê±¸ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ maturin build --release
ğŸ”— Found pyo3 bindings
ğŸ Found CPython 3.8 at /Users/.local/share/virtualenvs/temp-nO4s4P8m/bin/python3
   Compiling target-lexicon v0.12.4
   Compiling once_cell v1.13.1
   Compiling proc-macro2 v1.0.43
   Compiling libc v0.2.132
   Compiling quote v1.0.21
   Compiling unicode-ident v1.0.3
   Compiling syn v1.0.99
   Compiling autocfg v1.1.0
   Compiling parking_lot_core v0.9.3
   Compiling cfg-if v1.0.0
   Compiling smallvec v1.9.0
   Compiling scopeguard v1.1.0
   Compiling unindent v0.1.10
   Compiling indoc v1.0.7
   Compiling lock_api v0.4.7
   Compiling pyo3-build-config v0.16.5
   Compiling parking_lot v0.12.1
   Compiling pyo3-ffi v0.16.5
   Compiling pyo3 v0.16.5
   Compiling pyo3-macros-backend v0.16.5
   Compiling pyo3-macros v0.16.5
   Compiling fibonacci v0.1.0 (/Users/code/temp)
    Finished release [optimized] target(s) in 20.61s
ğŸ“¦ Built wheel for CPython 3.8 to /Users/code/temp/target/wheels/fibonacci-0.1.0-cp38-cp38-macosx_10_7_x86_64.whl
```

ì´ì œ íŒŒì´ì¬ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ ìµœì í™”ëœ íŒ¨í‚¤ì§€ë¡œ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì‹¤í–‰ ê²°ê³¼

```bash
$ python main.py
python: 3.03, result: 9227465
rust: 0.03, result: 9227465
```
