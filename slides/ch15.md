---
marp: true
paginate: true
theme: default
---

# íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë¨¸ë¥¼ ìœ„í•œ ëŸ¬ìŠ¤íŠ¸ ì…ë¬¸

ìœ¤ì¸ë„
freedomzero91@gmail.com

---

# CH15. íŒŒì´ì¬ ë°”ì¸ë”©

---

ì´ë²ˆ ì±•í„°ì—ì„œëŠ” ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ íŒŒì´ì¬ì—ì„œ ì‹¤í–‰í•˜ëŠ” ë°©ë²•ì„ ë°°ì›Œë³´ê² ìŠµë‹ˆë‹¤. ëŸ¬ìŠ¤íŠ¸ì˜ ë†’ì€ ì„±ëŠ¥ ë•Œë¬¸ì—, ë§ì€ íŒŒì´ì¬ ê°œë°œìë“¤ì´ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ íŒŒì´ì¬ì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•œ ë„êµ¬ë¥¼ ê°œë°œí–ˆìŠµë‹ˆë‹¤. ê·¸ ì¤‘ì—ì„œ ê°€ì¥ ë„ë¦¬ ì‚¬ìš©ë˜ëŠ” PyO3 í¬ë ˆì´íŠ¸ì˜ ì‚¬ìš©ë²•ì„ ì•Œì•„ë³´ê² ìŠµë‹ˆë‹¤.

---

## íŒŒì´ì¬ ê°€ìƒí™˜ê²½ ë§Œë“¤ê¸°

### ê°€ìƒí™˜ê²½ì´ë€?

- í”„ë¡œì íŠ¸ ë‹¨ìœ„ë¡œ ì˜ì¡´ì„±ì´ ê´€ë¦¬ë˜ëŠ” ëŸ¬ìŠ¤íŠ¸ì™€ ë‹¬ë¦¬, íŒŒì´ì¬ì€ í•˜ë‚˜ì˜ ê¸€ë¡œë²Œ ì¸í„°í”„ë¦¬í„° í™˜ê²½ì— ëª¨ë“  íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë©ë‹ˆë‹¤.
- í”„ë¡œì íŠ¸ë“¤ì—ì„œ ê°™ì€ íŒ¨í‚¤ì§€ë¥¼ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤ëŠ” ì¥ì ì´ ìˆì§€ë§Œ, í”„ë¡œì íŠ¸ë³„ë¡œ ë‹¤ë¥¸ íŒŒì´ì¬ ë²„ì „ê³¼ íŒ¨í‚¤ì§€ ë²„ì „ì„ ê´€ë¦¬í•˜ëŠ” ì¼ì´ ì–´ë ¤ì›Œì§€ëŠ” ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.
- íŒŒì´ì¬ì—ì„œ ê°€ìƒ í™˜ê²½ì„ ìƒì„±í•˜ëŠ” ë°©ë²•ì€ ì—¬ëŸ¬ ê°€ì§€ê°€ ìˆì§€ë§Œ, ì—¬ê¸°ì„œëŠ” `pipenv`ë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì†Œê°œí•©ë‹ˆë‹¤.

---

### pipenv

pipenvëŠ” pipenv ëª…ë ¹ì–´ í•˜ë‚˜ë¡œ ê°€ìƒí™˜ê²½ì˜ ìƒì„±, ì‚­ì œ, ì˜ì¡´ì„±ì˜ ì¶”ê°€, ì‚­ì œ, ì—…ë°ì´íŠ¸ ë“±ì„ ëª¨ë‘ í•  ìˆ˜ ìˆëŠ” í¸ë¦¬í•œ ë„êµ¬ì…ë‹ˆë‹¤.

pipenvëŠ” í”„ë¡œì íŠ¸ì˜ ê°€ìƒ í™˜ê²½ì„ ìë™ìœ¼ë¡œ ìƒì„± ë° ê´€ë¦¬í•˜ê³  íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜/ì œê±°í•  ë•Œ `Pipfile`ì—ì„œ íŒ¨í‚¤ì§€ë¥¼ ì¶”ê°€/ì œê±°í•©ë‹ˆë‹¤. ë˜í•œ íŒ¨í‚¤ì§€ ìœ íš¨ì„±ì„ ê²€ì‚¬í•˜ëŠ” ë° ì‚¬ìš©ë˜ëŠ” ë§¤ìš° ì¤‘ìš”í•œ `Pipfile.lock`ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
pip install pipenv
```

---

íŒŒì´ì¬ ë²„ì „ì„ ì§€ì •í•´ì„œ ê°€ìƒí™˜ê²½ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
pipenv --python 3.11
```

ìƒì„±ëœ ê°€ìƒí™˜ê²½ ì…¸ë¡œ ì§„ì…í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```bash
pipenv shell
```

---

ê°€ìƒí™˜ê²½ì— ìƒˆë¡œìš´ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.

```bash
pipenv install requests
```

ë§Œì¼ ê°œë°œ ë‹¨ê³„ì—ì„œë§Œ ì‚¬ìš©ë˜ëŠ” íˆ´ì´ë¼ë©´ `--dev` í”Œë˜ê·¸ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. ì˜ˆë¥¼ ë“¤ì–´ blackê³¼ ê°™ì€ í¬ë§¤í„° íŒ¨í‚¤ì§€ëŠ” ì‹¤ì œ ì†ŒìŠ¤ì½”ë“œì—ì„œëŠ” ì“°ì´ì§€ ì•Šê³  ê°œë°œ ë‹¨ê³„ì—ì„œë§Œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— ë‹¤ìŒê³¼ ê°™ì‹œ ì„¤ì¹˜í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
pipenv install --dev black
```

---

ê²°ê³¼ì ìœ¼ë¡œ ì¼ë°˜ íŒ¨í‚¤ì§€ì™€ ê°œë°œ íŒ¨í‚¤ì§€ê°€ Pipfileì— êµ¬ë¶„ë˜ì–´ì„œ ì¶”ê°€ë˜ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```toml
[[source]]
url = "https://pypi.org/simple"
verify_ssl = true
name = "pypi"

[packages]
requests = "*"

[dev-packages]
black = "*"

[requires]
python_version = "3.11"

[pipenv]
allow_prereleases = true

```

---

## ëŸ¬ìŠ¤íŠ¸ í”„ë¡œì íŠ¸ ìƒì„±í•˜ê¸°

### íŒŒì´ì¬ ë°”ì¸ë”©ì´ë€?

íŒŒì´ì¬ ë°”ì¸ë”©ì€ ë‹¤ë¥¸ í”„ë¡œê·¸ë˜ë° ì–¸ì–´ë¡œ ì‘ì„±ëœ ì½”ë“œë¥¼ íŒŒì´ì¬ì—ì„œ ì‚¬ìš©í•˜ëŠ” ê²ƒì„ ì˜ë¯¸í•©ë‹ˆë‹¤.

---

### PyO3

PyO3ëŠ” íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆê³ , ë°˜ëŒ€ë¡œ ëŸ¬ìŠ¤íŠ¸ì—ì„œ íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ ë„ì™€ì£¼ëŠ” í¬ë ˆì´íŠ¸ì…ë‹ˆë‹¤.

### maturin

maturinì€ ìµœì†Œí•œì˜ êµ¬ì„±ìœ¼ë¡œ ëŸ¬ìŠ¤íŠ¸ë¡œ ì‘ì„±í•œ íŒŒì´ì¬ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•  ìˆ˜ ìˆëŠ” ë„êµ¬ì…ë‹ˆë‹¤.

```bash
$ pipenv install maturin --dev
$ pipenv shell
```

---

maturinìœ¼ë¡œ pyo3 í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•©ë‹ˆë‹¤. -b ì˜µì…˜ì„ ì£¼ë©´ pyo3ë¥¼ ë¹Œë“œ ì‹œìŠ¤í…œìœ¼ë¡œ í•´ì„œ í”„ë¡œì íŠ¸ê°€ ìƒì„±ë©ë‹ˆë‹¤.

```bash
$ maturin init -b pyo3
  âœ¨ Done! New project created string_sum

```

---

í”„ë¡œì íŠ¸ë¥¼ ìƒì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì€ í´ë” êµ¬ì¡°ê°€ ë§Œë“¤ì–´ì§‘ë‹ˆë‹¤.

```
.
â”œâ”€â”€ Cargo.lock
â”œâ”€â”€ Cargo.toml
â”œâ”€â”€ Pipfile
â”œâ”€â”€ pyproject.toml
â”œâ”€â”€ src
    â””â”€â”€ lib.rs
```

---

`Cargo.toml`íŒŒì¼ì—ì„œ íŒ¨í‚¤ì§€ì™€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ ì´ë¦„ì„ "fibonacci"ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.

```toml
[package]
name = "fibonacci"
version = "0.1.0"
edition = "2021"

# See more keys and their definitions at https://doc.rust-lang.org/cargo/reference/manifest.html
[lib]
name = "fibonacci"
crate-type = ["cdylib"]

[dependencies]
pyo3 = { version = "0.16.5", features = ["extension-module"] }
```

---

`pyproject.toml` íŒŒì¼ì—ì„œë„ í”„ë¡œì íŠ¸ ì´ë¦„ì„ "fibonacci"ë¡œ ìˆ˜ì •í•©ë‹ˆë‹¤.

```toml
[build-system]
requires = ["maturin>=0.13,<0.14"]
build-backend = "maturin"

[project]
name = "fibonacci"
requires-python = ">=3.7"
classifiers = [
    "Programming Language :: Rust",
    "Programming Language :: Python :: Implementation :: CPython",
    "Programming Language :: Python :: Implementation :: PyPy",
]

```

---

### ë¼ì´ë¸ŒëŸ¬ë¦¬ í¬ë ˆì´íŠ¸ ë§Œë“¤ê¸°

- ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ì— `#[pyfunction]` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ PyO3ëŠ” í•´ë‹¹ í•¨ìˆ˜ê°€ ì¼ë°˜ íŒŒì´ì¬ í•¨ìˆ˜ì¸ ê²ƒì²˜ëŸ¼ íŒŒì´ì¬ì—ì„œ í˜¸ì¶œí•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

- ëŸ¬ìŠ¤íŠ¸ í•¨ìˆ˜ì— `#[pymodule]` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ ì¶”ê°€í•˜ë©´ PyO3ëŠ” í•´ë‹¹ í•¨ìˆ˜ë¥¼ íŒŒì´ì¬ ëª¨ë“ˆì˜ ì´ˆê¸°í™” í•¨ìˆ˜ë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

- ëª¨ë“ˆì— í•¨ìˆ˜ë¥¼ ì¶”ê°€í•˜ë ¤ë©´ `add_function` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

---

```rust
use pyo3::prelude::*;

fn _run(n: u64) -> u64 {
    match n {
        0 => 0,
        1 => 1,
        _ => _run(n - 1) + _run(n - 2),
    }
}

#[pyfunction]
fn run(n: u64) -> PyResult<u64> {
    Ok(_run(n))
}

/// A Python module implemented in Rust.
#[pymodule]
fn fibonacci(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(run, m)?)?;
    Ok(())
}

```

---

## íŒŒì´ì¬ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œ ì‹¤í–‰í•´ ë³´ê¸°

### ê°œë°œ ëª¨ë“œë¡œ ë¹Œë“œí•´ë³´ê¸°

`maturin develop` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•˜ë©´, ëŸ¬ìŠ¤íŠ¸ íŒ¨í‚¤ì§€ë¥¼ ë¹Œë“œí•œ ë‹¤ìŒ íŒŒì´ì¬ ê°€ìƒí™˜ê²½ì— íŒ¨í‚¤ì§€ë¥¼ ìë™ìœ¼ë¡œ ì„¤ì¹˜í•´ì¤ë‹ˆë‹¤. ì´ë•Œ ëŸ¬ìŠ¤íŠ¸ ì»´íŒŒì¼ íƒ€ê²Ÿì´ `[unoptimized + debuginfo]`ê°€ ë˜ëŠ”ë°, ë¹ ë¥¸ ê°œë°œì„ ìœ„í•´ ì½”ë“œ ì„±ëŠ¥ë³´ë‹¤ëŠ” ì»´íŒŒì¼ ì†ë„ë¥¼ ì¤‘ìš”í•˜ê²Œ ìƒê°í•œ ì˜µì…˜ì…ë‹ˆë‹¤.

---

```bash
$ maturin develop
ğŸ”— Found pyo3 bindings
ğŸ Found CPython 3.8 at /Users/.local/share/virtualenvs/ch14-4UzrGkRt/bin/python
   Compiling pyo3-build-config v0.16.5
   Compiling pyo3-ffi v0.16.5
   Compiling pyo3 v0.16.5
   Compiling fibonacci v0.1.0 (/Users/code/Tutorials/sap_rust_tutorial/ch14)
    Finished dev [unoptimized + debuginfo] target(s) in 12.64s
ğŸ“¦ Built wheel for CPython 3.8 to /var/folders/74/l6jhlmk114g8kx1pzz2s9fm80000gn
/T/.tmpBh1Xiw/fibonacci-0.1.0-cp38-cp38-macosx_10_7_x86_64.whl
ğŸ›   Installed fibonacci-0.1.0
```

---

> ë§Œì¼ ê°€ìƒí™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ì§€ ì•Šì„ ê²½ìš° ì—ëŸ¬ê°€ ë°œìƒí•˜ë¯€ë¡œ ì£¼ì˜í•˜ì„¸ìš”!
>
> ```bash
> $ maturin develop
> ğŸ’¥ maturin failed
>   Caused by: You need to be inside a virtualenv or conda environment to use develop
> (neither VIRTUAL_ENV nor CONDA_PREFIX are set).
> See https://virtualenv.pypa.io/en/latest/index.html
> on how to use virtualenv or use `maturin build` and
> `pip install <path/to/wheel>` instead.
> ```

---

`main.py` íŒŒì¼ì„ ë§Œë“¤ê³  ë‹¤ìŒ ì½”ë“œë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤. íŒŒì´ì¬ìœ¼ë¡œ í”¼ë³´ë‚˜ì¹˜ ìˆ˜ì—´ì„ êµ¬í•˜ëŠ” í•¨ìˆ˜ `pyrun` ì„ ì¶”ê°€í•´ ëŸ¬ìŠ¤íŠ¸ êµ¬í˜„ì²´ì™€ ì„±ëŠ¥ì„ ë¹„êµí•´ë´…ë‹ˆë‹¤.

```python
import time

from fibonacci import run


def pyrun(n: int):
    if n < 2:
        return n

    return pyrun(n - 1) + pyrun(n - 2)


N = 35

start = time.time()
result = pyrun(N)
print(f"python: {time.time()-start:.2f}, result: {result}")
start = time.time()
result = run(N)
print(f"rust: {time.time()-start:.2f}, result: {result}")

```

---

ì‹¤í–‰ ê²°ê³¼

```bash
$ python main.py
python: 3.13, result: 9227465
rust: 0.10, result: 9227465
```

---

### ë¦´ë¦¬ì¦ˆ ëª¨ë“œë¡œ ë¹Œë“œí•´ë³´ê¸°

ë¹Œë“œ ì˜µì…˜ì„ `--release` ë¡œ ì£¼ë©´, ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ìµœëŒ€í•œ ìµœì í™”í•´ì„œ ì»´íŒŒì¼í•œ ë°”ì´ë„ˆë¦¬ê°€ íŒ¨í‚¤ì§€ë¡œ ë§Œë“¤ì–´ì§€ê²Œ ë©ë‹ˆë‹¤. ì»´íŒŒì¼ íƒ€ê²Ÿì´ `[optimized]`ì¸ ê±¸ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
$ maturin build --release
ğŸ”— Found pyo3 bindings
ğŸ Found CPython 3.8 at /Users/.local/share/virtualenvs/temp-nO4s4P8m/bin/python3
   Compiling target-lexicon v0.12.4
    ...
   Compiling pyo3-macros v0.16.5
   Compiling fibonacci v0.1.0 (/Users/code/temp)
    Finished release [optimized] target(s) in 20.61s
ğŸ“¦ Built wheel for CPython 3.8 to /Users/code/temp/target/wheels/fibonacci-0.1.0-cp38-cp38-macosx_10_7_x86_64.whl
```

---

ì´ì œ íŒŒì´ì¬ ì½”ë“œë¥¼ ê·¸ëŒ€ë¡œ ì‹¤í–‰í•˜ë©´ ìµœì í™”ëœ íŒ¨í‚¤ì§€ë¡œ ì‹¤í–‰ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

ì‹¤í–‰ ê²°ê³¼

```bash
$ python main.py
python: 3.03, result: 9227465
rust: 0.03, result: 9227465
```

---

## PyO3ì™€ GIL

ì•ì—ì„œëŠ” ë‹¨ì¼ ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•˜ëŠ” ì˜ˆì œë¥¼ ì‚´í´ë´¤ìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì´ ê°•ì˜ì˜ ê°€ì¥ í° ëª©í‘œì¸ íŒŒì´ì¬ GILì„ ìš°íšŒí•˜ëŠ” ëŸ¬ìŠ¤íŠ¸ íŒ¨í‚¤ì§€ë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œëŠ” ë©€í‹°ìŠ¤ë ˆë“œ í™˜ê²½ì—ì„œ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‹¤í–‰í•´ë³´ì•„ì•¼ í•©ë‹ˆë‹¤. ì´ë¥¼ ì‚´í´ë³´ê¸° ìœ„í•´ì„œ ìƒˆë¡œìš´ í”„ë¡œì íŠ¸ `gil`ì„ ìƒì„±í•©ë‹ˆë‹¤.

```bash
maturin init -b pyo3
```

---

### GIL íšë“ê³¼ í•´ì œ

- `py.allow_threads`ëŠ” PyO3ì—ì„œ ì œê³µí•˜ëŠ” ë©”ì„œë“œë¡œ, í´ë¡œì €ë¥¼ ì‹¤í–‰í•˜ëŠ” ë™ì•ˆ GILì„ ì¼ì‹œì ìœ¼ë¡œ í•´ì œ
- PyO3ì—ì„œ GILì„ í•´ì œí•˜ëŠ” ë‹¤ë¥¸ ë°©ë²•ìœ¼ë¡œëŠ” `Python::with_gil` ë©”ì„œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ëª…ì‹œì ìœ¼ë¡œ GILì„ íšë“í•˜ê³  í•´ì œ

---

```rust
// lib.rs
use std::thread;
use std::time::Duration;

use pyo3::prelude::*;
use pyo3::types::PyList;

#[pyfunction]
fn double_list(list: &PyList, result: &PyList, idx: usize) -> PyResult<()> {
    println!("Rust: Enter double_list...");
    thread::sleep(Duration::from_secs(1));
    let doubled: Vec<i32> = list.extract::<Vec<i32>>()?.iter().map(|x| x * 2).collect();
    Python::with_gil(|py| {
        println!("Rust: Acquire GIL...");
        thread::sleep(Duration::from_secs(1));
        let py_list = PyList::new(py, &doubled);
        println!("Rust: Exit...");
        result.set_item(idx, py_list)
    })
}

/// A Python module implemented in Rust.
#[pymodule]
fn gil(_py: Python, m: &PyModule) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(double_list, m)?)?;
    Ok(())
}

```

---

íŒŒì´ì¬ì—ì„œ `sleep` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ GILì„ í•´ì œí•œ ë‹¤ìŒ ëŸ¬ìŠ¤íŠ¸ ì½”ë“œì™€ ë²ˆê°ˆì•„ê°€ë©´ì„œ ì‹¤í–‰ë˜ëŠ” ì˜ˆì œì…ë‹ˆë‹¤.

```python
import time
import threading

from gil import double_list


def double_list_py(list, result, idx):
    print("Py: Enter double_list_py...")
    time.sleep(0.1)
    result[idx] = [x * 2 for x in list]
    print("Py: Exit...")


result = [[], []]
nums = [1, 2, 3]

t1 = threading.Thread(target=double_list_py, args=(nums, result, 0))
t2 = threading.Thread(target=double_list, args=(nums, result, 1))

t1.start()
t2.start()

t1.join()
t2.join()

print(f"Py: {result[0]}")
print(f"Rust: {result[1]}")

```

---

ì‹¤í–‰ ê²°ê³¼

```
Py: Enter double_list_py...
Rust: Enter double_list...
Rust: Acquire GIL...
Rust: Exit...
Py: Exit...
Py: [2, 4, 6]
Rust: [2, 4, 6]
```
