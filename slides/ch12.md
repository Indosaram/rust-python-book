---
marp: true
paginate: true
theme: default
---

# íŒŒì´ì¬ í”„ë¡œê·¸ë˜ë¨¸ë¥¼ ìœ„í•œ ëŸ¬ìŠ¤íŠ¸ ì…ë¬¸

ìœ¤ì¸ë„
freedomzero91@gmail.com

---

# CH12. ë©€í‹°ìŠ¤ë ˆë”©

---

ì´ë²ˆ ì±•í„°ì—ì„œëŠ” ëŸ¬ìŠ¤íŠ¸ì˜ ìŠ¤ë ˆë“œê°€ ì–´ë–»ê²Œ ë§Œë“¤ì–´ì§€ëŠ”ì§€, ê·¸ë¦¬ê³  ì–´ë–»ê²Œ ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œê°€ ì•ˆì „í•˜ê²Œ ë©”ëª¨ë¦¬ë¥¼ ê³µìœ í•˜ëŠ”ì§€ë¥¼ ë°°ì›Œë³´ê² ìŠµë‹ˆë‹¤.

---

## ìŠ¤ë ˆë“œ ìŠ¤í°

í”„ë¡œì„¸ìŠ¤ì—ì„œ ìŠ¤ë ˆë“œë¥¼ ë§Œë“œëŠ” ê²ƒì„ ìŠ¤ë ˆë“œë¥¼ ìŠ¤í°(spawn)í•œë‹¤ê³  ë§í•©ë‹ˆë‹¤.

### ì‹±ê¸€ ìŠ¤ë ˆë“œ ìŠ¤í°í•˜ê¸°

ëª¨ë“  í”„ë¡œê·¸ë¨ì€ ë©”ì¸ ìŠ¤ë ˆë“œë¡œë¶€í„° ì‹œì‘í•©ë‹ˆë‹¤. ë©”ì¸ ìŠ¤ë ˆë“œê°€ `main` í•¨ìˆ˜ë¥¼ ì‹¤í–‰í•˜ê³ , ë‹¤ë¥¸ ìŠ¤ë ˆë“œë“¤ì„ ì‹¤í–‰ì‹œí‚¬ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ìŠ¤ë ˆë“œ í•œ ê°œë¥¼ ìŠ¤í°í•˜ëŠ” ë°©ë²•ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

---

```python
from threading import Thread

from time import sleep


def func1():
    for i in range(0, 10):
        print(f"Hello, can you hear me?: {i}")
        sleep(0.001)


thread = Thread(target=func1)
thread.start()

for i in range(0, 5):
    print(f"Hello from the main thread: {i}")
    sleep(0.001)

```

---

```
Hello, can you hear me?: 0
Hello from the main thread: 0
Hello from the main thread: 1
Hello from the main thread: 2
Hello from the main thread: 3
Hello from the main thread: 4
Hello, can you hear me?: 1
Hello, can you hear me?: 2
Hello, can you hear me?: 3
Hello, can you hear me?: 4
Hello, can you hear me?: 5
Hello, can you hear me?: 6
Hello, can you hear me?: 7
Hello, can you hear me?: 8
Hello, can you hear me?: 9
```

---

ëŸ¬ìŠ¤íŠ¸ì—ì„œëŠ” ìƒˆë¡œìš´ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¤ ë•Œ í‘œì¤€ ë¼ì´ë¸ŒëŸ¬ë¦¬ì˜ `std::thread::spawn` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 0..10 {
            println!("Hello, can you hear me?: {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 0..5 {
        println!("Hello from the main thread: {}", i);
        thread::sleep(Duration::from_millis(1));
    }

    handle.join().unwrap();
}

```

---

ì‹¤í–‰ ê²°ê³¼

```
Hello from the main thread: 0
Hello, can you hear me?: 0
Hello from the main thread: 1
Hello, can you hear me?: 1
Hello from the main thread: 2
Hello, can you hear me?: 2
Hello, can you hear me?: 3
Hello from the main thread: 3
Hello, can you hear me?: 4
Hello from the main thread: 4
Hello, can you hear me?: 5
Hello, can you hear me?: 6
Hello, can you hear me?: 7
Hello, can you hear me?: 8
Hello, can you hear me?: 9
```

---

### ëŒ€ëª¬(daemon) ìŠ¤ë ˆë“œ ë§Œë“¤ê¸°

ìŠ¤í°í•  ìŠ¤ë ˆë“œë¥¼ ëŒ€ëª¬ ìŠ¤ë ˆë“œë¡œ ë§Œë“¤ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤. ëŒ€ëª¬ ìŠ¤ë ˆë“œëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë˜ë©°, ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ë©´ í•¨ê»˜ ì¢…ë£Œë˜ëŠ” ìŠ¤ë ˆë“œì…ë‹ˆë‹¤.

---

```python
from threading import Thread

from time import sleep


def func1():
    for i in range(0, 10):
        print(f"Hello, can you hear me?: {i}")
        sleep(0.001)


thread = Thread(target=func1, daemon=True)
thread.start()

for i in range(0, 5):
    print(f"Hello from the main thread: {i}")
    sleep(0.001)

```

---

```
Hello, can you hear me?: 0
Hello from the main thread: 0
Hello, can you hear me?: 1
Hello from the main thread: 1
Hello from the main thread: 2
Hello, can you hear me?: 2
Hello, can you hear me?: 3
Hello from the main thread: 3
Hello from the main thread: 4
Hello, can you hear me?: 4
```

---

`join` ì„ í˜¸ì¶œí•˜ë©´ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ì§€ ì•Šê³ , ìƒì„±ëœ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤. ë§Œì¼ ë©”ì¸ í•¨ìˆ˜ì—ì„œ `join` ì„ í˜¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´, ìŠ¤í°ëœ ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ ì¤‘ì´ë”ë¼ë„ ë©”ì¸ ìŠ¤ë ˆë“œê°€ ì¢…ë£Œë˜ì–´ í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë©ë‹ˆë‹¤.

```rust
use std::thread;
use std::time::Duration;

fn main() {
    thread::spawn(|| {
        for i in 0..10 {
            println!("Hello, can you hear me?: {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });

    for i in 0..5 {
        println!("Hello from the main thread: {}", i);
        thread::sleep(Duration::from_millis(1));
    }
}

```

---

ì‹¤í–‰ ê²°ê³¼

```
Hello from the main thread: 0
Hello, can you hear me?: 0
Hello from the main thread: 1
Hello, can you hear me?: 1
Hello from the main thread: 2
Hello, can you hear me?: 2
Hello from the main thread: 3
Hello, can you hear me?: 3
Hello from the main thread: 4
Hello, can you hear me?: 4
Hello, can you hear me?: 5
```

---

### `join` ì„ ì‚¬ìš©í•´ ìŠ¤ë ˆë“œ ê¸°ë‹¤ë¦¬ê¸°

ì¼ë°˜ì ìœ¼ë¡œ ìŠ¤ë ˆë“œëŠ” ì‹œì‘ëœ ë‹¤ìŒ `join` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•´ ìŠ¤ë ˆë“œ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì§‘ë‹ˆë‹¤.

---

```python
from threading import Thread

from time import sleep


def func1():
    for i in range(0, 10):
        print(f"Hello, can you hear me?: {i}")
        sleep(0.001)


thread = Thread(target=func1)
thread.start()
thread.join()

for i in range(0, 5):
    print(f"Hello from the main thread: {i}")
    sleep(0.001)

```

---

ì‹¤í–‰ ê²°ê³¼

```
Hello, can you hear me?: 0
Hello, can you hear me?: 1
Hello, can you hear me?: 2
Hello, can you hear me?: 3
Hello, can you hear me?: 4
Hello, can you hear me?: 5
Hello, can you hear me?: 6
Hello, can you hear me?: 7
Hello, can you hear me?: 8
Hello, can you hear me?: 9
Hello from the main thread: 0
Hello from the main thread: 1
Hello from the main thread: 2
Hello from the main thread: 3
Hello from the main thread: 4
```

---

ì´ë²ˆì—ëŠ” `join()`ì„ ì‚¬ìš©í•´ ìŠ¤í°ëœ ìŠ¤ë ˆë“œê°€ ëê¹Œì§€ ì‹¤í–‰ë˜ê¸°ë¥¼ ê¸°ë‹¤ë ¸ë‹¤ê°€ ë©”ì¸ ìŠ¤ë ˆë“œë¥¼ ì‹¤í–‰í•©ë‹ˆë‹¤.

```rust
use std::thread;
use std::time::Duration;

fn main() {
    let handle = thread::spawn(|| {
        for i in 0..10 {
            println!("Hello, can you hear me?: {}", i);
            thread::sleep(Duration::from_millis(1));
        }
    });
    handle.join().unwrap();

    for i in 0..5 {
        println!("Hello from the main thread: {}", i);
        thread::sleep(Duration::from_millis(1));
    }
}

```

---

ì‹¤í–‰ ê²°ê³¼

```
Hello, can you hear me?: 0
Hello, can you hear me?: 1
Hello, can you hear me?: 2
Hello, can you hear me?: 3
Hello, can you hear me?: 4
Hello, can you hear me?: 5
Hello, can you hear me?: 6
Hello, can you hear me?: 7
Hello, can you hear me?: 8
Hello, can you hear me?: 9
Hello from the main thread: 0
Hello from the main thread: 1
Hello from the main thread: 2
Hello from the main thread: 3
Hello from the main thread: 4
```

---

## ìŠ¤ë ˆë“œì™€ ì†Œìœ ê¶Œ

`std::thread::spawn`ì—ëŠ” í•¨ìˆ˜ ì´ë¦„ì„ ì „ë‹¬í•  ìˆ˜ë„ ìˆì§€ë§Œ, ì•ì—ì„œì²˜ëŸ¼ í´ë¡œì €(closure)ë¥¼ ì „ë‹¬í•˜ëŠ” ê²½ìš°ê°€ ë” ë§ìŠµë‹ˆë‹¤. í´ë¡œì €ë¥¼ ì‚¬ìš©í•˜ë©´ íŠ¹ì • ê°’ì„ ìŠ¤ë ˆë“œ ì•ˆìœ¼ë¡œ ì´ë™ì‹œí‚¤ëŠ” ê²ƒì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```rust
let numbers = vec![1, 2, 3];
thread::spawn(move || {
    for n in numbers {
        println!("{n}");
    }
})
.join()
.unwrap();
```

---

í´ë¡œì €ì˜ ë¦¬í„´ê°’ì€ ìŠ¤ë ˆë“œë¡œ ì „ë‹¬ë©ë‹ˆë‹¤. ì´ ê°’ì€ `join` ë©”ì†Œë“œê°€ í˜¸ì¶œë  ë•Œ `Result`ë¡œ ê°ì‹¸ì ¸ì„œ ë¦¬í„´ë©ë‹ˆë‹¤.

```rust
let numbers = Vec::from_iter(0..=1000);

let t = thread::spawn(move || {
    let len = numbers.len();
    let sum = numbers.into_iter().sum::<usize>();
    sum / len // 1
});

let average = t.join().unwrap(); // 2
println!("average: {average}");
```

---

### ë²”ìœ„ ì œí•œ(scoped) ìŠ¤ë ˆë“œ

ë§Œì¼ ì–´ë–¤ ìŠ¤ë ˆë“œê°€ ë°˜ë“œì‹œ íŠ¹ì • ë²”ìœ„ì—ì„œë§Œ ì¡´ì¬í•˜ëŠ” ê²ƒì´ í™•ì‹¤í•  ê²½ìš°, ë²”ìœ„ ì œí•œ ìŠ¤ë ˆë“œë¥¼ ë§Œë“¤ê¸° ìœ„í•´ì„œ `std::thread::scope`ë¥¼ ì‚¬ìš©í•˜ë©´ ë©ë‹ˆë‹¤.

```rust
use std::thread;

fn main() {
    let numbers = vec![1, 2, 3];

    thread::scope(|s| {
        s.spawn(|| {
            println!("length: {}", numbers.len());
        });
        s.spawn(|| {
            for n in &numbers {
                println!("{n}");
            }
        });
    });
}

```

---

1. ë¨¼ì € ìŠ¤ë ˆë“œì˜ ë²”ìœ„ë¥¼ ë§Œë“¤ì–´ì£¼ê¸° ìœ„í•´ `std::thread::scope` í•¨ìˆ˜ì— í´ë¡œì €ë¥¼ ì „ë‹¬í•©ë‹ˆë‹¤. í•´ë‹¹ í´ë¡œì €ëŠ” ì¦‰ì‹œ ì‹¤í–‰ë˜ê³ , í˜„ì¬ ë²”ìœ„ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ì¸ì `s`ë¥¼ ì…ë ¥ìœ¼ë¡œ ë°›ìŠµë‹ˆë‹¤.
2. ê·¸ë‹¤ìŒ `s`ë¥¼ ì‚¬ìš©í•´ ìŠ¤ë ˆë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤. ìŠ¤ë ˆë“œì— ì „ë‹¬ë˜ëŠ” í´ë¡œì €ëŠ” ì§€ì—­ ë³€ìˆ˜ `numbers`ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
3. ë²”ìœ„ê°€ ëë‚  ë•Œ, ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œë“¤ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.

---

í•˜ì§€ë§Œ ì½”ë“œë¥¼ ì•„ë˜ì™€ ê°™ì´ ë°”ê¿”ì„œ `numbers`ì— ìƒˆë¡œìš´ ê°’ì„ ë„£ìœ¼ë ¤ê³  í•˜ë©´ ì»´íŒŒì¼ ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

```rust
use std::thread;

fn main() {
    let mut numbers = vec![1, 2, 3];
    thread::scope(|s| {
        s.spawn(|| {
            numbers.push(1);
        });
        s.spawn(|| {
            numbers.push(2); // Error!
        });
    });
}

```

---

## GIL(Global interpreter lock)

GILì€ í•œ ë²ˆì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ íŒŒì´ì¬ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰í•˜ë„ë¡ í•˜ê¸° ìœ„í•´ ì¸í„°í”„ë¦¬í„°ì—ì„œ ì‚¬ìš©ë˜ëŠ” ë½(lock)ì…ë‹ˆë‹¤. ìŠ¤ë ˆë“œê°€ GILì„ íšë“í•˜ë©´ íŒŒì´ì¬ ë°”ì´íŠ¸ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆì§€ë§Œ ë‹¤ë¥¸ ëª¨ë“  ìŠ¤ë ˆë“œëŠ” GILì´ í•´ì œë  ë•Œê¹Œì§€ íŒŒì´ì¬ ì½”ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ì—†ë„ë¡ ì°¨ë‹¨ë©ë‹ˆë‹¤.

---

### GILì˜ ë‹¨ì 

- GILì€ ë©€í‹°ìŠ¤ë ˆë“œ í”„ë¡œê·¸ë¨, íŠ¹íˆ CPUì— ë°”ì¸ë”©ëœ ì‘ì—…ì„ í¬í•¨í•˜ëŠ” í”„ë¡œê·¸ë¨ì˜ ì„±ëŠ¥ì— ì¹˜ëª…ì ì¸ ì˜í–¥ì„ ì¤ë‹ˆë‹¤.
- í•œ ìŠ¤ë ˆë“œê°€ CPUì— ë°”ì¸ë”©ëœ ì‘ì—…ì„ ì‹¤í–‰í•˜ëŠ” ê²½ìš°, ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ I/O ë˜ëŠ” ê¸°íƒ€ CPUì— ë°”ì¸ë”©ë˜ì§€ ì•Šì€ ì‘ì—…ì„ ëŒ€ê¸° ì¤‘ì´ë”ë¼ë„ ì‘ì—…ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¤ì•¼ í•©ë‹ˆë‹¤.

GILì˜ í•œê³„ë¥¼ ê·¹ë³µí•˜ê¸° ìœ„í•´ íŒŒì´ì¬ì€ ëª‡ ê°€ì§€ ê¸°ëŠ¥ì„ ì§€ì›í•©ë‹ˆë‹¤.

- ë¹„ë™ê¸° í”„ë¡œê·¸ë˜ë°
- ë©€í‹°ìŠ¤ë ˆë”©
- ë©€í‹°í”„ë¡œì„¸ì‹±
- ì œí•œì  GIL í•´ì œ

---

### GIL ê²½í•©(contention) ë¬¸ì œ

ì•„ë˜ ì½”ë“œë¥¼ ì‹¤í–‰í•´ ë³´ë©´ `count` í•¨ìˆ˜ë¥¼ ì—°ì†ìœ¼ë¡œ ë‘ ë²ˆ í˜¸ì¶œí•˜ëŠ” ê²ƒê³¼, ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒê³¼ì˜ ì‹¤ì œ ì‹¤í–‰ ì†ë„ ì°¨ì´ê°€ ê·¸ë¦¬ í¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

---

```python
import time
import threading

N = 10000000

def count(n):
    for i in range(n):
        pass

start = time.time()
count(N)
count(N)
print(f"Elapsed time(sequential): {(time.time() - start) * 1000:.3f}ms")

start = time.time()
t1 = threading.Thread(target=count, args=(N,))
t2 = threading.Thread(target=count, args=(N,))

t1.start()
t2.start()

t1.join()
t2.join()

print(f"Elapsed time(threaded): {(time.time() - start) * 1000:.3f}ms")
```

---

ì‹¤í–‰ ê²°ê³¼

```python
Elapsed time(sequential): 0.4786410331726074
Elapsed time(threaded): 0.4163088798522949
```

---

## ë©”ëª¨ë¦¬ ê³µìœ 

## ìŠ¤ë ˆë“œ ì†Œìœ ê¶Œê³¼ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…

ì§€ê¸ˆê¹Œì§€ ê°ì²´ì˜ ì†Œìœ ê¶Œì„ `move` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•´ í´ë¡œì €ë¡œ ë„˜ê¸°ê±°ë‚˜, ë²”ìœ„ ì œí•œ ìŠ¤ë ˆë“œë¥¼ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì„ ì‚´í´ë³´ì•˜ìŠµë‹ˆë‹¤. ë‘ ìŠ¤ë ˆë“œê°€ ë°ì´í„°ë¥¼ ê³µìœ í•˜ëŠ” ìƒí™©ì—ì„œ, ë‘ ìŠ¤ë ˆë“œ ëª¨ë‘ê°€ ë‚˜ë¨¸ì§€ í•˜ë‚˜ë³´ë‹¤ ë” ì˜¤ë˜ ì¡´ì¬í•œë‹¤ëŠ” ì‚¬ì‹¤ì´ ë³´ì¥ë˜ì§€ ì•ŠëŠ”ë‹¤ë©´, ì–´ë–¤ ìŠ¤ë ˆë“œë„ ë°ì´í„°ì˜ ì†Œìœ ê¶Œì„ ê°€ì§ˆ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³µìœ ë˜ëŠ” ì–´ë–¤ ë°ì´í„°ë„ ë‘ ìŠ¤ë ˆë“œë³´ë‹¤ ë” ì˜¤ë˜ ì¡´ì¬í•´ì•¼ë§Œ í•©ë‹ˆë‹¤.

---

### ìŠ¤íƒœí‹±(static)

`static` ë³€ìˆ˜ëŠ” í”„ë¡œê·¸ë¨ ìì²´ê°€ ì†Œìœ ê¶Œì„ ê°€ì§€ê¸° ë•Œë¬¸ì— ë°˜ë“œì‹œ ì–´ë–¤ ìŠ¤ë ˆë“œë³´ë‹¤ë„ ì˜¤ë˜ ì¡´ì¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```rust
static X: [i32; 3] = [1, 2, 3];
thread::spawn(|| dbg!(&X));
thread::spawn(|| dbg!(&X));
```

---

### ìœ ì¶œ(Leaking)

`Box::leak` í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë©´ `Box`ì˜ ì†Œìœ ê¶Œì„ í•´ì œí•˜ê³  ì ˆëŒ€ ì´ ê°’ì´ ì‚­ì œë˜ì§€ ì•Šê²Œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì´ë•Œë¶€í„° `Box`ëŠ” í”„ë¡œê·¸ë¨ì´ ì¢…ë£Œë  ë•Œê¹Œì§€ ì¡´ì¬í•˜ê²Œ ë˜ê³  ì–´ëŠ ìŠ¤ë ˆë“œì—ì„œë„ ê°’ì„ ë¹Œë ¤ ê°ˆ ìˆ˜ ìˆê²Œ ë©ë‹ˆë‹¤.

```rust
let x: &'static [i32; 3] = Box::leak(Box::new([1, 2, 3]));

thread::spawn(move || dbg!(x));
thread::spawn(move || dbg!(x));
```

---

### ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…

*ì†Œìœ ê¶Œì„ ê³µìœ *í•´ì„œ í•´ë‹¹ ë°ì´í„°ì˜ ì†Œìœ ìë“¤ì„ ì§€ì†ì ìœ¼ë¡œ ê´€ë¦¬í•¨ìœ¼ë¡œì¨ ë” ì´ìƒ í•´ë‹¹ ë°ì´í„°ì˜ ì†Œìœ ìê°€ ì—†ì„ ë•Œ ê°ì²´ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```rust
use std::rc::Rc;

let a = Rc::new([1, 2, 3]);
let b = a.clone();

assert_eq!(a.as_ptr(), b.as_ptr()); // Same allocation!
```

---

í•˜ì§€ë§Œ `Rc`ë¥¼ ë‹¤ë¥¸ ìŠ¤ë ˆë“œë¡œ ë³´ë‚´ë ¤ê³  í•˜ë©´ ì—ëŸ¬ê°€ ë°œìƒí•©ë‹ˆë‹¤.

```
    error[E0277]: `Rc` cannot be sent between threads safely
        |
    8   |     thread::spawn(move || dbg!(b));
        |                   ^^^^^^^^^^^^^^^
```

---

### Arc(Atomic refernce counting)

ëŒ€ì‹  ì•„í† ë¯¹(atomically)í•œ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŒ…ì„ ì‚¬ìš©í•˜ëŠ” `std::sync::Arc`ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. `Rc`ì™€ ë™ì¼í•œ ê¸°ëŠ¥ì„ ì œê³µí•˜ì§€ë§Œ, `Arc`ëŠ” ì—¬ëŸ¬ ìŠ¤ë ˆë“œì—ì„œ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´í„°ë¥¼ ë³€ê²½í•˜ëŠ” ê²ƒì´ í—ˆìš©ëœë‹¤ëŠ” ì ì´ ë‹¤ë¦…ë‹ˆë‹¤. ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´í„°ê°€ ë³€ê²½ë˜ëŠ” ì‘ì—…ì´ ì•„í† ë¯¹í•˜ê²Œ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸ì—, ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œì—ì„œ ë™ì‹œì— ì¹´ìš´í„°ë¥¼ ë³€ê²½í•˜ë”ë¼ë„ ìŠ¤ë ˆë“œ ì•ˆì „ì„±ì´ ë³´ì¥ë©ë‹ˆë‹¤.

---

```rust
use std::sync::Arc;

let a = Arc::new([1, 2, 3]);
let b = a.clone();

thread::spawn(move || dbg!(a));
thread::spawn(move || dbg!(b));
```

- (1)ì—ì„œ ë°°ì—´ì„ `Arc`ë¥¼ ì‚¬ìš©í•´ ë©”ëª¨ë¦¬ì— í• ë‹¹í•©ë‹ˆë‹¤. ì´ë•Œ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´í„°ëŠ” 1ì´ ë©ë‹ˆë‹¤.
- `Arc`ë¥¼ í´ë¡ í•˜ë©´ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´íŠ¸ëŠ” 2ê°€ ë˜ê³ , `a`ì™€ `b` ëª¨ë‘ ê°™ì€ ë©”ëª¨ë¦¬ ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.
- ê° ìŠ¤ë ˆë“œë§ˆë‹¤ ê³ ìœ í•œ `Arc`ë¥¼ ì „ë‹¬ë°›ì•˜ìŠµë‹ˆë‹¤. ì¦‰ ë°°ì—´ì´ ìŠ¤ë ˆë“œ ì‚¬ì´ì— ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤. ê° ìŠ¤ë ˆë“œì—ì„œ `Arc`ê°€ ì‚­ì œë  ë•Œë§ˆë‹¤ ë ˆí¼ëŸ°ìŠ¤ ì¹´ìš´í„°ê°€ ê°ì†Œí•˜ê³ , ì¹´ìš´í„°ê°€ 0ì´ ë˜ë©´ ë°°ì—´ì€ ë©”ëª¨ë¦¬ì—ì„œ í• ë‹¹ í•´ì œë©ë‹ˆë‹¤.

---

## ë®¤í…ìŠ¤(mutex)

ë®¤í…ìŠ¤ëŠ” Mutual exclusion(ìƒí˜¸ ë°°ì œ)ì˜ ì•½ìë¡œ, ë®¤í…ìŠ¤ëŠ” ì£¼ì–´ì§„ ì‹œê°„ì— í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë§Œ ë°ì´í„°ì— ì•¡ì„¸ìŠ¤í•  ìˆ˜ ìˆë„ë¡ í—ˆìš©í•©ë‹ˆë‹¤. ë®¤í…ìŠ¤ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ë‘ ê°€ì§€ ê·œì¹™ì„ ì§€ì¼œì•¼ í•©ë‹ˆë‹¤.

- ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ê¸° ì „ì— ë°˜ë“œì‹œ ì ê¸ˆì„ í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤.
- ë®¤í…ìŠ¤ê°€ ë³´í˜¸í•˜ëŠ” ë°ì´í„°ë¥¼ ì‚¬ìš©í•œ í›„ì—ëŠ” ë‹¤ë¥¸ ìŠ¤ë ˆë“œê°€ ì ê¸ˆì„ íšë“í•  ìˆ˜ ìˆë„ë¡ ë°ì´í„°ì˜ ì ê¸ˆì„ í•´ì œí•´ì•¼ í•©ë‹ˆë‹¤.

---

#### ë®¤í…ìŠ¤ì˜ API

ë®¤í…ìŠ¤ ì‚¬ìš© ë°©ë²•ì„ ì‚´í´ë³´ê¸° ìœ„í•´ ë‹¨ì¼ ìŠ¤ë ˆë“œì—ì„œ ë®¤í…ìŠ¤ë¥¼ ì‚¬ìš©í•˜ëŠ” ê²ƒë¶€í„° ì‹œì‘í•´ ë³´ê² ìŠµë‹ˆë‹¤.

```rust
use std::sync::Mutex;

fn main() {
    let m = Mutex::new(5);

    {
        let mut num = m.lock().unwrap();
        *num = 6;
    }

    println!("m = {:?}", m);
}

```

---

ì‹¤í–‰ ê²°ê³¼

```
m = Mutex { data: 6, poisoned: false, .. }
```

---

balanceê°€ ì¸ì¶œí•˜ê³ ì í•˜ëŠ” ê¸ˆì•¡ë³´ë‹¤ í¬ë‹¤ê³  íŒë‹¨í•´ ì”ê³ ë¥¼ ì¸ì¶œí•©ë‹ˆë‹¤.

```python
import threading
import time

balance = 100

def withdraw(amount):
    global balance
    if balance >= amount:
        time.sleep(0.01)
        balance -= amount
        print(f"Withdrawal successful. Balance: {balance}")
    else:
        print("Insufficient balance.")

def main():
    t1 = threading.Thread(target=withdraw, args=(50,))
    t2 = threading.Thread(target=withdraw, args=(75,))
    t1.start()
    t2.start()
    t1.join()
    t2.join()

if __name__ == '__main__':
    main()
```

---

ì‹¤í–‰ ê²°ê³¼

```python
Withdrawal successful. Balance: 50
Withdrawal successful. Balance: -25
```

---

ìŠ¤ë ˆë“œê°€ lockì„ íšë“í–ˆì„ ë•Œë§Œ ë°ì´í„°ì— ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ í•˜ë©´ ì´ëŸ¬í•œ ë¬¸ì œë¥¼ ë§‰ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```python
import time
import threading

balance = 100
lock = threading.Lock()

def withdraw(amount):
    global balance
    thread_id = threading.get_ident()
    with lock:
        print(f"Thread {thread_id}: Checking balance...")
        if balance >= amount:
            time.sleep(1)
            balance -= amount
            print(f"Thread {thread_id}: Withdrawal successful. Balance: {balance}")
        else:
            print(f"Thread {thread_id}: Insufficient balance.")

def check_lock():
    while lock.locked():
        print("Lock is locked.")
        time.sleep(0.1)

def main():
    t1 = threading.Thread(target=withdraw, args=(50,))
    t2 = threading.Thread(target=withdraw, args=(75,))
    t3 = threading.Thread(target=check_lock)
    t1.start()
    t2.start()
    t3.start()
    t1.join()
    t2.join()
    t3.join()

if __name__ == '__main__':
    main()
```

---

ì‹¤í–‰ ê²°ê³¼

```python
Thread 123145503645696: Checking balance...
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Thread 123145503645696: Withdrawal successful. Balance: 50
Thread 123145520435200: Checking balance...
Thread 123145520435200: Insufficient balance.
```

---

ë‹¤ìŒ ì½”ë“œëŠ” 10ê°œì˜ ìŠ¤ë ˆë“œê°€ 100ë²ˆì”© 1ì”© ì¦ê°€í•˜ëŠ” ê°’ì„ ë”í•˜ëŠ” ì½”ë“œì…ë‹ˆë‹¤.

```rust
use std::sync::Arc;
use std::thread;
use std::time::Duration;

fn withdraw(balance: &mut i32, amount: i32) {
    if *balance >= amount {
        thread::sleep(Duration::from_millis(10));
        *balance -= amount;
        println!("Withdrawal successful. Balance: {balance}");
    } else {
        println!("Insufficient balance.");
    }
}

fn main() {
    let mut balance = Arc::new(100);

    let t1 = thread::spawn(move || {
        withdraw(&mut balance, 50); // ğŸ¤¯
    });

    let t2 = thread::spawn(move || {
        withdraw(&mut balance, 75);
    });

    t1.join().unwrap();
    t2.join().unwrap();
}

```

---

ë®¤í…ìŠ¤ë¥¼ ì‚¬ìš©!

```rust
use std::sync::{Arc, Mutex};
use std::thread;
use std::time::Duration;

fn withdraw(balance: Arc<Mutex<i32>>, amount: i32) {
    let mut balance = balance.lock().unwrap();
    println!("{:?}: Checking balance.", thread::current().id());
    if *balance >= amount {
        thread::sleep(Duration::from_millis(100));
        *balance -= amount;
        println!("Withdrawal successful. Balance: {balance}");
    } else {
        println!("Insufficient balance.");
    }
}

fn check_lock(balance: Arc<Mutex<i32>>) {
    while let Err(_) = balance.try_lock() {
        println!("Lock is locked.");
        thread::sleep(Duration::from_millis(10));
    }
}

```

---

```rust
fn main() {
    let balance = Arc::new(Mutex::new(100));

    let balance1 = Arc::clone(&balance);
    let t1 = thread::spawn(move || {
        withdraw(Arc::clone(&balance1), 50);
    });
    let balance2 = Arc::clone(&balance);
    let t2 = thread::spawn(move || {
        withdraw(Arc::clone(&balance2), 75);
    });
    let balance3 = Arc::clone(&balance);
    let t3 = thread::spawn(move || {
        check_lock(Arc::clone(&balance3));
    });

    t1.join().unwrap();
    t2.join().unwrap();
    t3.join().unwrap();
}
```

---

ì‹¤í–‰ ê²°ê³¼

```
ThreadId(2): Checking balance.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Lock is locked.
Withdrawal successful. Balance: 50
ThreadId(3): Checking balance.
Insufficient balance.
```

---

## ë©”ì‹œì§€ ì „ë‹¬

ìŠ¤ë ˆë“œ ê°„ì— ë°ì´í„°ë¥¼ ê³µìœ í•˜ëŠ” ë°©ë²• ì¤‘ í•˜ë‚˜ë¡œ ë„ë¦¬ ì“°ì´ëŠ” ê²ƒ ì¤‘ í•˜ë‚˜ê°€ ë°”ë¡œ MPSCì…ë‹ˆë‹¤. ë‹¤ì¤‘ ìƒì„±ì-ë‹¨ì¼ ì†Œë¹„ì(Multiple {roducer Single Consumer)ë€ ëœ»ìœ¼ë¡œ, ì—¬ëŸ¬ ê°œì˜ ìŠ¤ë ˆë“œì—ì„œ í•˜ë‚˜ì˜ ìŠ¤ë ˆë“œë¡œ ë°ì´í„°ë¥¼ ë³´ë‚´ëŠ” ë°©ì‹ì…ë‹ˆë‹¤.

íŒŒì´ì¬ì—ì„œëŠ” ê³µì‹ì ìœ¼ë¡œ MPSCë¥¼ ë§Œë“œëŠ” ë°©ë²•ì´ ì—†ê¸° ë•Œë¬¸ì—, ìŠ¤ë ˆë“œ ì•ˆì •ì„±ì´ ë³´ì¥ë˜ëŠ” í ìë£Œí˜•ì¸ `Queue` ë¥¼ ì‚¬ìš©í•´ ì´ë¥¼ êµ¬í˜„í•´ ë³´ê² ìŠµë‹ˆë‹¤.

---

```python
import threading
import time
from queue import Queue

channel = Queue(maxsize=3)


def producer():
    for msg in ["hello", "from", "the", "other", "side"]:
        print(f"Producing {msg}...")
        channel.put(msg)


def consumer():
    while not channel.empty():
        item = channel.get()
        print(f"Consuming {item}...")
        channel.task_done()
        time.sleep(0.01)


producer_thread = threading.Thread(target=producer)
producer_thread.start()

consumer_thread = threading.Thread(target=consumer)
consumer_thread.start()

producer_thread.join()
consumer_thread.join()

```

---

ì±„ë„ì€ `Sender`ì™€ `Receiver`ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤.

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        for msg in vec!["hello", "from", "the", "other", "side"] {
            let val = String::from(msg);
            println!("Producing {}...", val);
            tx.send(val).unwrap();
            thread::sleep(Duration::from_millis(10));
        }
    });

    for re in rx {
        println!("Consuming {}...", re);
    }
}

```

---

`try_recv` ë¥¼ ì‚¬ìš©í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;

fn main() {
    let (tx, rx) = mpsc::channel();

    thread::spawn(move || {
        let val = String::from("hello");
        thread::sleep(Duration::from_millis(1000));
        tx.send(val).unwrap();
    });

    loop {
        println!("Waiting for the signal...");
        if let Ok(received) = rx.try_recv() {
            println!("Message: {}", received);
            break;
        }

        thread::sleep(Duration::from_millis(300));
    }
}

```

---

rxê°€ ì–´ë–»ê²Œ ì•ì˜ ë©”ì‹œì§€ë¥¼ ë‹¤ ê¸°ë‹¤ë¦´ ìˆ˜ ìˆëŠ”ì§€? Receiver, ì¦‰ `rx`ëŠ” ì†¡ì‹ ì `tx` ê°€ ë©”ì‹œì§€ë¥¼ ì „ì†¡í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ë ¤ê³  ì‹œë„í•˜ë©°, í•´ë‹¹ ì±„ë„ì´ ëŠì–´ì§€ë©´ ì˜¤ë¥˜ë¥¼ ë°˜í™˜í•©ë‹ˆë‹¤.

---

```rust
use std::sync::mpsc;
use std::thread;
use std::time::Duration;

fn main() {
    let (tx, rx) = mpsc::channel();

    let tx1 = tx.clone();
    thread::spawn(move || {
        for msg in vec!["hello", "from", "the", "other", "side"] {
            let val = String::from(msg);
            thread::sleep(Duration::from_millis(100));
            tx1.send(val).unwrap();
        }
    });

    thread::spawn(move || {
        let val = String::from("bye");
        thread::sleep(Duration::from_millis(1000));
        tx.send(val).unwrap();
    });

    for re in rx {
        println!("{}", re);
    }
}

```
